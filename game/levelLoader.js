var l = 
// {
//     width:8,
//     height:6,
//     layer0: "1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 1 1 2 2 2 2 2 2 1 1 2 2 2 2 2 2 1 1 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1",
//     layer1: "0 0 0 0 0 0 0 0 0 0 1 1 1 1 0 d d 0 0 0 0 0 0 0 0 0 1 1 1 0 0 0 0 0 0 2 0 2 0 0 0 0 0 0 0 0 1 1"
// }
{ width: 10, height: 10, layer0: "0 0 1 1 1 1 1 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 ", layer1: "0 0 4 4 4 4 4 4 0 0 0 0 4 2 0 0 0 4 0 0 0 0 3 0 0 0 1 4 0 0 0 0 4 1 2 0 1 4 0 0 0 0 4 0 0 0 1 4 0 0 0 0 4 1 2 0 1 4 0 0 0 0 4 1 0 0 1 4 0 0 0 0 4 2 0 0 0 3 0 0 0 0 4 4 4 4 4 4 0 0 0 0 0 0 0 0 0 0 0 0 "}

var l2 = { width: 20, height: 20, layer0: "0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ", layer1: "0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4 4 4 4 4 4 4 4 4 4 4 4 4 4 0 0 0 0 0 0 4 2 2 0 0 0 0 0 0 0 0 0 0 4 0 0 0 0 0 0 4 0 0 0 0 0 0 1 1 1 1 0 0 4 0 0 0 0 0 0 4 1 1 1 0 0 0 1 0 0 0 0 2 4 0 0 0 0 0 0 3 0 0 0 0 0 0 1 0 2 0 0 2 4 0 0 0 0 0 0 4 1 1 1 0 0 0 1 0 0 0 0 2 4 0 0 0 0 0 0 4 0 0 0 0 0 0 1 1 1 1 0 0 4 0 0 0 0 0 0 4 0 0 0 0 0 0 0 0 0 0 0 0 4 0 0 0 0 0 0 4 0 0 0 0 0 0 1 1 1 1 0 0 4 0 0 0 0 0 0 4 2 2 2 0 0 0 0 0 0 0 0 2 4 0 0 0 0 0 0 4 2 2 2 0 0 0 0 0 0 0 2 2 4 0 0 0 0 0 0 4 4 4 4 4 4 4 3 4 4 4 4 4 4 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 "}
//original objects for level
var originalBlockList = Array(); // for the background layer

var originalEntityFall;
var originalEntityRock;
var originalEntityDoor;
var originalBoxCollider;

//init original prefabs
function initLevelLoader(scene)
{
    //first load the atlas texture
    var atlas = new BABYLON.Texture("atlas.png", scene, false, true, BABYLON.Texture.NEAREST_SAMPLINGMODE);

    //define default material for tiles
    var tileMaterial = new BABYLON.StandardMaterial("noLight", scene);
    tileMaterial.disableLighting = true;
    tileMaterial.emissiveColor = BABYLON.Color3.White();
    tileMaterial.diffuseTexture = atlas;
    tileMaterial.diffuseTexture.hasAlpha = true;

    //tiles
    for(let i=0; i<3; i++)
        originalBlockList.push(CreateTile(scene, i));

    originalEntityFall = CreateTile(scene, 2);
    originalEntityRock = CreateTile(scene, 3);
    originalEntityDoor = CreateTile(scene, 4);

    originalBoxCollider = BABYLON.MeshBuilder.CreateBox("b", {size:0}, scene);
    originalBoxCollider.isVisible = false;

    function CreateTile(scene, textureIndex)
    {
        var faceUV = new BABYLON.Vector4(textureIndex/8, 0, (textureIndex+1)/8, 1/6);

        var tile = BABYLON.MeshBuilder.CreatePlane("tile", {frontUVs:faceUV, width:1, height:1, sideOrientation:BABYLON.Mesh.DOUBLESIDE}, scene);
        tile.material = tileMaterial;
        tile.position = new BABYLON.Vector3(0, -100, 0);

        return tile;
    }
}

var walls = Array();
var doors = Array();

function loadlevel(level)
{
    var level_tab = level["layer0"].split(' ');

    var level_h = level.height;
    var level_w = level.width;

    var x_offset = level.width/2;
    var y_offset = level.height/2;

    var backgroundTiles = Array();
    var entities = Array();
    walls = Array();

    // first layer
    for(let h = 0; h < level_h; h++)
    {
        for(let w = 0; w < level_w; w++)
        {
            var tile = level_tab[w + h*level_w];
            var pos = new BABYLON.Vector3(w - x_offset, (level_h - h) - y_offset, 0);
            if(tile == "1")
                backgroundTiles.push(instantiateTile(originalBlockList[0], pos));
            if(tile == "2")
                backgroundTiles.push(instantiateTile(originalBlockList[1], pos));
        }
    }

    var level_entities = level["layer1"].split(' ');

    // entity layer
    for(let h = 0; h < level_h; h++)
    {
        for(let w = 0; w < level_w; w++)
        {
            var tile = level_entities[w + h*level_w];
            var pos = new BABYLON.Vector3(w - x_offset, (level_h - h) - y_offset, 0);

            if(tile == "1")
            {
                entities.push(instantiateTile(originalEntityFall, pos));
                entities.push(instantiateBlock(pos));
            }
            if(tile == "2")
            {
                entities.push(instantiateTile(originalEntityRock, pos));
                entities.push(instantiateBlock(pos));
            }
                
            if(tile == "3")
            {
                var door = instantiateTile(originalEntityDoor, pos)
                //entities.push(door);
                doors.push(door);
            }
                
            if(tile == "4") //boxwall
                walls.push(instantiateBlock(pos));
        }
    }
}

// --- instances function ---

function instantiateTile(tile, position)
{
    var instance = tile.createInstance("tileInstance");
    instance.position = position;

    return instance;
}

function instantiateBlock(position)
{
    var instance = instantiateTile(originalBoxCollider, position);
    instance.checkCollisions = true;
    instance.isVisible = false;

    return instance;
}

function generateDungeon()
{
    var dungeonRoomsMin = 4;

}