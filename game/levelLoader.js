var l = 
{ "width": 10, "height": 10, "layer0": "1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 ", "layer1": "1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 1 1 0 2 2 2 2 2 2 0 1 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 5 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1 1 0 2 2 2 2 2 2 0 1 1 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 "}
//{ width: 10, height: 10, layer0: "0 0 1 1 1 1 1 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 ", layer1: "0 0 4 4 4 4 4 4 0 0 0 0 4 2 0 0 0 4 0 0 0 0 3 0 0 0 1 4 0 0 0 0 4 1 2 0 1 4 0 0 0 0 4 0 0 0 1 4 0 0 0 0 4 1 2 0 1 4 0 0 0 0 4 1 0 0 1 4 0 0 0 0 4 2 0 0 0 3 0 0 0 0 4 4 4 4 4 4 0 0 0 0 0 0 0 0 0 0 0 0 "}

var l2 = { width: 20, height: 20, layer0: "0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ", layer1: "0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4 4 4 4 4 4 4 4 4 4 4 4 4 4 0 0 0 0 0 0 4 2 2 0 0 0 0 0 0 0 0 0 0 4 0 0 0 0 0 0 4 0 0 0 0 0 0 1 1 1 1 0 0 4 0 0 0 0 0 0 4 1 1 1 0 0 0 1 0 0 0 0 2 4 0 0 0 0 0 0 3 0 0 0 0 0 0 1 0 2 0 0 2 4 0 0 0 0 0 0 4 1 1 1 0 0 0 1 0 0 0 0 2 4 0 0 0 0 0 0 4 0 0 0 0 0 0 1 1 1 1 0 0 4 0 0 0 0 0 0 4 0 0 0 0 0 0 0 0 0 0 0 0 4 0 0 0 0 0 0 4 0 0 0 0 0 0 1 1 1 1 0 0 4 0 0 0 0 0 0 4 2 2 2 0 0 0 0 0 0 0 0 2 4 0 0 0 0 0 0 4 2 2 2 0 0 0 0 0 0 0 2 2 4 0 0 0 0 0 0 4 4 4 4 4 4 4 3 4 4 4 4 4 4 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 "}

var llevel = Array();
//llevel.push({ width: 10, height: 10, layer0: "1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 ", layer1: "1 1 1 1 1 1 1 1 1 1 1 3 0 0 0 0 0 0 3 1 1 0 2 2 2 2 2 2 0 1 7 0 0 0 2 0 0 0 0 1 1 0 0 0 2 0 2 0 0 5 1 0 0 0 0 0 2 0 0 1 1 0 0 0 0 0 2 0 0 1 1 0 2 2 2 2 2 2 0 1 1 3 0 0 0 0 0 0 3 1 1 1 1 1 1 1 1 1 1 1 "});
// llevel.push({ width: 10, height: 10, layer0: "1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 ", layer1: "1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 2 2 0 1 1 0 2 3 2 0 3 2 0 5 1 0 0 3 2 0 3 0 0 1 1 0 0 3 2 0 3 0 0 1 1 0 0 3 0 0 3 0 0 1 1 0 0 3 0 0 3 0 0 1 7 0 2 3 0 2 3 2 0 1 1 0 2 2 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 "});

// llevel.push({ width: 10, height: 5, layer0: "1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 ", layer1: "1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 1 7 0 0 2 2 2 2 0 0 5 1 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 "});
// llevel.push({ width: 10, height: 5, layer0: "1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 ", layer1: "1 1 1 1 1 1 1 1 1 1 1 3 0 3 0 0 3 0 3 1 7 0 0 0 0 0 0 0 0 5 1 3 0 3 0 0 3 0 3 1 1 1 1 1 1 1 1 1 1 1 "});
// llevel.push({ width: 10, height: 5, layer0: "1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 ", layer1: "1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 1 7 0 0 3 0 0 0 0 0 5 1 0 0 0 0 0 3 0 0 1 1 1 1 1 1 1 1 1 1 1 "});

//llevel.push({ width: 10, height: 10, layer0: "10 10 10 10 10 10 10 10 10 10 10 14 14 14 14 14 14 14 14 10 10 15 15 15 15 15 15 15 15 10 10 12 11 12 12 12 12 11 12 10 10 12 12 12 12 12 12 12 12 10 10 12 12 12 12 12 12 12 12 10 10 12 12 12 12 12 12 12 12 10 10 12 11 12 12 12 12 11 12 10 10 12 12 12 12 12 12 12 12 10 10 10 10 10 10 10 10 10 10 10 ", layer1: "1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1 7 0 0 0 0 0 0 0 0 5 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 "});
//llevel.push({ width: 10, height: 10, layer0: "10 10 10 10 10 10 10 10 10 10 10 14 14 14 14 14 14 14 14 10 10 12 12 11 15 15 15 15 15 10 10 14 14 12 15 15 15 15 15 10 10 15 15 12 12 12 11 15 15 10 10 15 15 11 12 12 12 15 15 10 10 15 15 14 14 14 12 15 15 10 10 15 15 15 15 15 11 12 12 10 10 15 15 15 15 15 14 14 14 10 10 10 10 10 10 10 10 10 10 10 ", layer1: "1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 7 0 0 0 1 1 1 1 1 1 1 1 1 0 1 1 1 1 1 1 1 1 1 0 0 0 0 1 1 1 1 1 1 0 0 0 0 1 1 1 1 1 1 1 1 1 0 1 1 1 1 1 1 1 1 1 0 0 0 5 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 "});
//llevel.push({ "width": 10, "height": 10, "layer0": "10 10 10 10 10 10 10 10 10 10 10 14 14 14 14 14 14 14 14 10 10 15 15 15 15 15 15 15 15 10 10 12 11 12 12 12 12 11 12 10 10 12 12 12 12 12 12 12 12 10 10 12 12 12 12 12 12 12 12 10 10 12 12 12 12 12 12 12 12 10 10 12 11 12 12 12 12 11 12 10 10 12 12 12 12 12 12 12 12 10 10 10 10 10 10 10 10 10 10 10 ", "layer1": "1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1 7 0 0 0 0 0 0 0 0 5 1 0 0 0 0 0 0 0 0 1 1 0 8 0 0 0 0 8 0 1 1 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 "});
llevel.push({ "width": 10, "height": 10, "layer0": "17 17 17 17 17 17 17 17 17 17 17 13 19 18 18 19 18 18 13 17 17 18 13 19 18 18 19 13 18 17 17 18 18 13 18 19 13 18 18 17 17 18 19 18 13 13 18 18 18 17 17 19 18 19 13 13 18 19 18 17 17 18 18 13 18 18 13 18 19 17 17 18 13 18 19 18 18 13 18 17 17 13 18 18 18 18 19 19 13 17 17 17 17 17 17 17 17 17 17 17 ", "layer1": "1 1 1 1 1 1 1 1 1 1 1 8 0 0 0 0 0 0 8 1 1 0 0 0 0 0 0 0 0 5 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1 7 0 0 0 0 0 0 0 0 1 1 8 0 0 0 0 0 0 8 1 1 1 1 1 1 1 1 1 1 1 "});
// llevel.push();
// llevel.push();


//var bossRoom = { width: 10, height: 10, layer0: "1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 ", layer1: "1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1 1 2 2 2 0 0 2 2 2 1 1 1 1 1 1 4 1 1 1 1 "};
var bossRoom = { "width": 13, "height": 10, "layer0": "10 10 10 10 10 10 10 10 10 10 10 10 10 10 14 14 14 14 14 14 14 14 14 14 14 10 10 11 12 12 12 12 12 12 12 12 12 11 10 10 14 9 9 9 12 12 12 9 9 9 14 10 10 15 9 9 9 12 12 12 9 9 9 15 10 10 15 9 9 9 12 12 12 9 9 9 15 10 10 15 9 9 9 12 12 12 9 9 9 15 10 10 15 9 9 9 12 12 12 9 9 9 15 10 10 11 9 9 9 12 12 12 9 9 9 11 10 10 10 10 10 10 10 10 10 10 10 10 10 10 ", "layer1": "1 1 1 1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 2 2 2 1 1 0 0 0 0 0 0 0 0 0 0 0 1 1 2 0 0 0 0 0 0 0 0 0 2 1 1 2 0 0 0 0 0 0 0 0 0 2 1 1 2 0 0 0 0 0 0 0 0 0 2 1 1 2 0 0 0 0 0 0 0 0 0 2 1 1 2 0 0 0 0 0 0 0 0 0 2 1 1 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 4 1 1 1 1 1 1 "};
//original objects for level
var originalBlockList = Array(); // for the background layer

var originalEntityFall;
var originalEntityRock;
var originalEntityDoorN;
var originalEntityDoorE;
var originalEntityDoorS;
var originalEntityDoorO;
var originalBoxCollider;

//init original prefabs
function initLevelLoader(scene)
{
    //first load the atlas texture
    var atlas = new BABYLON.Texture("./media/atlas.png", scene, false, true, BABYLON.Texture.NEAREST_SAMPLINGMODE);

    //define default material for tiles
    var tileMaterial = new BABYLON.StandardMaterial("noLight", scene);
    tileMaterial.disableLighting = true;
    tileMaterial.emissiveColor = BABYLON.Color3.White();
    tileMaterial.diffuseTexture = atlas;
    tileMaterial.diffuseTexture.hasAlpha = true;

    //tiles
    for(let i=0; i<20; i++)
        originalBlockList.push(CreateTile(scene, i));

    originalEntityFall = CreateTile(scene, 2);
    originalEntityRock = CreateTile(scene, 3);
    originalEntityDoorN = CreateTile(scene, 4);
    originalEntityDoorE = CreateTile(scene, 5);
    originalEntityDoorS = CreateTile(scene, 6);
    originalEntityDoorO = CreateTile(scene, 7);

    originalBoxCollider = BABYLON.MeshBuilder.CreateBox("b", {size:0}, scene);
    originalBoxCollider.isVisible = false;

    function CreateTile(scene, textureIndex)
    {
        var columns = 8;
        var rows = 6;
        var textureOffset = 0.001; // pour fix les le clipping de la texture
        //var faceUV = new BABYLON.Vector4(textureIndex/8, 0, (textureIndex+1)/8, 1/6);
        var faceUV = new BABYLON.Vector4((textureIndex/8)%1 + textureOffset, Math.floor(textureIndex/8)/6 + textureOffset, (textureIndex/8)%1 + 1/8 - textureOffset, Math.floor(textureIndex/8)/6 + 1/6 - textureOffset);
        //var faceUV = new BABYLON.Vector4(5/8, 0/6, (5+1)/8, 1/6);
        console.log(faceUV);
        var tile = BABYLON.MeshBuilder.CreatePlane("tile", {frontUVs:faceUV, width:1, height:1, sideOrientation:BABYLON.Mesh.DOUBLESIDE}, scene);
        tile.material = tileMaterial;
        tile.position = new BABYLON.Vector3(0, -100, 0);

        return tile;
    }
}

var walls = Array();
var doors = Array();
var backgroundTiles = Array();
var entities = Array();

var currentdjRoom = 0;
var dj = Array();

function loadnewlevel(level)
{
    var level_tab = level["layer0"].split(' ');

    var level_h = level.height;
    var level_w = level.width;

    var x_offset = level.width/2;
    var y_offset = level.height/2;

    walls.forEach(e => e.dispose());
    doors.forEach(e => e.dispose());
    backgroundTiles.forEach(e => e.dispose());
    entities.forEach(e => e.dispose());
    
    var levelwalls = Array();
    var leveldoors = Array();
    var levelbackgroundTiles = Array();
    var levelentities = Array();
    var levelMobs = Array();

    

    // first layer
    for(let h = 0; h < level_h; h++)
    {
        for(let w = 0; w < level_w; w++)
        {
            var tile = level_tab[w + h*level_w];
            var pos = new BABYLON.Vector3(w - x_offset, (level_h - h) - y_offset, 0);
            if(tile == "1")
                levelbackgroundTiles.push(instantiateTile(originalBlockList[0], pos));
            if(tile == "2")
                levelbackgroundTiles.push(instantiateTile(originalBlockList[1], pos));
            if(tile == "9")
                levelbackgroundTiles.push(instantiateTile(originalBlockList[8], pos));
            if(tile == "10")
                levelbackgroundTiles.push(instantiateTile(originalBlockList[9], pos));
            if(tile == "11")
                levelbackgroundTiles.push(instantiateTile(originalBlockList[10], pos));
            if(tile == "12")
                levelbackgroundTiles.push(instantiateTile(originalBlockList[11], pos));
            if(tile == "13")
                levelbackgroundTiles.push(instantiateTile(originalBlockList[12], pos));
            if(tile == "14")
                levelbackgroundTiles.push(instantiateTile(originalBlockList[13], pos));
            if(tile == "15")
                levelbackgroundTiles.push(instantiateTile(originalBlockList[14], pos));
            if(tile == "17")
                levelbackgroundTiles.push(instantiateTile(originalBlockList[16], pos));
            if(tile == "18")
                levelbackgroundTiles.push(instantiateTile(originalBlockList[17], pos));
            if(tile == "19")
                levelbackgroundTiles.push(instantiateTile(originalBlockList[18], pos));
        }
    }

    var level_entities = level["layer1"].split(' ');

    // entity layer
    for(let h = 0; h < level_h; h++)
    {
        for(let w = 0; w < level_w; w++)
        {
            var tile = level_entities[w + h*level_w];
            var pos = new BABYLON.Vector3(w - x_offset, (level_h - h) - y_offset, 0);

            if(tile == "1") //boxwall
                levelwalls.push(instantiateBlock(pos));

            if(tile == "2")
            {
                //you cant walk on a wall but projectile can go through
                //levelentities.push(instantiateTile(originalEntityFall, pos));
                levelentities.push(instantiateBlock(pos));
            }
            if(tile == "3")
            {
                levelentities.push(instantiateTile(originalEntityRock, pos));
                levelentities.push(instantiateBlock(pos));
            }
                
            if(tile == "4")
            {
                var door = instantiateTile(originalEntityDoorN, pos)
                //entities.push(door);
                leveldoors.push(["n",door, 0]);
            }
            if(tile == "5")
            {
                var door = instantiateTile(originalEntityDoorE, pos)
                //entities.push(door);
                leveldoors.push(["e",door, 0]);
            }
            if(tile == "6")
            {
                var door = instantiateTile(originalEntityDoorS, pos)
                //entities.push(door);
                leveldoors.push(["s",door, 0]);
            }
            if(tile == "7")
            {
                var door = instantiateTile(originalEntityDoorO, pos)
                //entities.push(door);
                leveldoors.push(["o",door, 0]);
            }
            if(tile == "8")
            {
                //enemy spawn...
                var monster = new mob(pos.x, pos.y);
                levelMobs.push(monster);
            }
        }
    }
    
    console.log("level loaded!");
    //reload le level fait bug les projectiles
    var level = {"walls": levelwalls, "doors": leveldoors, "tiles": levelbackgroundTiles, "entities": levelentities, "mobs": levelMobs, "collectibles": Array() };
    return level;

}

// --- instances function ---

function instantiateTile(tile, position)
{
    var instance = tile.createInstance("tileInstance");
    instance.position = position;

    return instance;
}

function instantiateBlock(position)
{
    var instance = instantiateTile(originalBoxCollider, position);
    instance.checkCollisions = true;
    instance.isVisible = false;

    return instance;
}


function getOpposideDirection(dir)
{
    let targetDir = "s"; // south
    if(dir == "e") targetDir = "o"; //west
    if(dir == "s") targetDir = "n"; //north
    if(dir == "o") targetDir = "e"; //east

    return targetDir;
}

function findRoomWithDir(dir)
{
    let dirvalue = "4";
    if(dir == "e") dirvalue = "5";
    if(dir == "s") dirvalue = "6";
    if(dir == "o") dirvalue = "7";

    validRooms = Array();
    llevel.forEach(room => {
        if(room.layer1.includes(dirvalue))
            validRooms.push(room);
    })

    return validRooms[Math.floor(Math.random()*(validRooms.length))];
}

function generateDungeon()
{
    var dungeonRoomsMin = 4;
    var dungeonRoomsMax = 8;
    var dungeonRoomsCount = Math.floor(Math.random() * (dungeonRoomsMax - dungeonRoomsMin + 1) + dungeonRoomsMin);

    var dungeonLayout = Array();

    var startlevelData = loadnewlevel(l);
    startlevelData['doors'][0][2] = 1;
    dungeonLayout.push(startlevelData);
    //enableRoom(levelData, false);

    var lastRoomNextDir = "e";

    for(let i=0;i<dungeonRoomsCount;i++)
    {
        //we search for the opposite direction
        let targetDir = getOpposideDirection(lastRoomNextDir);
        var dungeonLevel = findRoomWithDir(targetDir);
        var levelData = loadnewlevel(dungeonLevel);

        if(levelData['doors'][0][0] == targetDir)
        {
            levelData['doors'][0][2] = -1;
            levelData['doors'][1][2] = 1;
            lastRoomNextDir = levelData['doors'][1][0];
        }
        else
        {
            levelData['doors'][0][2] = 1;
            levelData['doors'][1][2] = -1;
            lastRoomNextDir = levelData['doors'][0][0];
        }

        dungeonLayout.push(levelData);
        enableRoom(levelData, false);
    }

    //boss room
    var endlevelData = loadnewlevel(bossRoom);
    endlevelData['doors'][0][2] = -1;
    endlevelData["mobs"].push(new boss(0,3));
    dungeonLayout.push(endlevelData);

    enableRoom(endlevelData, false);


    console.log("dungeon generated: " + dungeonRoomsCount + " rooms");
    return dungeonLayout;
}

function enableRoom(levelData, enabled)
{
    levelData['walls'].forEach(element => element.setEnabled(enabled));
    levelData['tiles'].forEach(element => element.setEnabled(enabled));
    levelData['doors'].forEach(element => element[1].setEnabled(enabled));
    levelData['entities'].forEach(element => element.setEnabled(enabled));
    levelData['mobs'].forEach(element => element.gameobject.setEnabled(enabled));
}