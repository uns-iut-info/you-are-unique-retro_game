var l = 
{ width: 10, height: 10, layer0: "1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 ", layer1: "1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 1 1 0 2 2 2 2 2 2 0 1 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 5 1 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 1 1 0 2 2 2 2 2 2 0 1 1 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 "}
//{ width: 10, height: 10, layer0: "0 0 1 1 1 1 1 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 2 2 2 2 1 0 0 0 0 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 ", layer1: "0 0 4 4 4 4 4 4 0 0 0 0 4 2 0 0 0 4 0 0 0 0 3 0 0 0 1 4 0 0 0 0 4 1 2 0 1 4 0 0 0 0 4 0 0 0 1 4 0 0 0 0 4 1 2 0 1 4 0 0 0 0 4 1 0 0 1 4 0 0 0 0 4 2 0 0 0 3 0 0 0 0 4 4 4 4 4 4 0 0 0 0 0 0 0 0 0 0 0 0 "}

var l2 = { width: 20, height: 20, layer0: "0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 2 2 2 2 2 2 2 2 2 2 2 2 1 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 ", layer1: "0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 4 4 4 4 4 4 4 4 4 4 4 4 4 4 0 0 0 0 0 0 4 2 2 0 0 0 0 0 0 0 0 0 0 4 0 0 0 0 0 0 4 0 0 0 0 0 0 1 1 1 1 0 0 4 0 0 0 0 0 0 4 1 1 1 0 0 0 1 0 0 0 0 2 4 0 0 0 0 0 0 3 0 0 0 0 0 0 1 0 2 0 0 2 4 0 0 0 0 0 0 4 1 1 1 0 0 0 1 0 0 0 0 2 4 0 0 0 0 0 0 4 0 0 0 0 0 0 1 1 1 1 0 0 4 0 0 0 0 0 0 4 0 0 0 0 0 0 0 0 0 0 0 0 4 0 0 0 0 0 0 4 0 0 0 0 0 0 1 1 1 1 0 0 4 0 0 0 0 0 0 4 2 2 2 0 0 0 0 0 0 0 0 2 4 0 0 0 0 0 0 4 2 2 2 0 0 0 0 0 0 0 2 2 4 0 0 0 0 0 0 4 4 4 4 4 4 4 3 4 4 4 4 4 4 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 "}

var llevel = Array();
llevel.push({ width: 10, height: 10, layer0: "1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 ", layer1: "1 1 1 1 1 1 1 1 1 1 1 3 0 0 0 0 0 0 3 1 1 0 2 2 2 2 2 2 0 1 7 0 0 0 2 0 0 0 0 1 1 0 0 0 2 0 2 0 0 5 1 0 0 0 0 0 2 0 0 1 1 0 0 0 0 0 2 0 0 1 1 0 2 2 2 2 2 2 0 1 1 3 0 0 0 0 0 0 3 1 1 1 1 1 1 1 1 1 1 1 "});
llevel.push({ width: 10, height: 10, layer0: "1 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 2 2 2 2 2 2 2 2 1 1 1 1 1 1 1 1 1 1 1 ", layer1: "1 1 1 1 1 1 1 1 1 1 1 0 0 0 0 0 2 2 0 1 1 0 2 3 2 0 3 2 0 5 1 0 0 3 2 0 3 0 0 1 1 0 0 3 2 0 3 0 0 1 1 0 0 3 0 0 3 0 0 1 1 0 0 3 0 0 3 0 0 1 7 0 2 3 0 2 3 2 0 1 1 0 2 2 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 1 "});
//original objects for level
var originalBlockList = Array(); // for the background layer

var originalEntityFall;
var originalEntityRock;
var originalEntityDoor;
var originalBoxCollider;

//init original prefabs
function initLevelLoader(scene)
{
    //first load the atlas texture
    var atlas = new BABYLON.Texture("atlas.png", scene, false, true, BABYLON.Texture.NEAREST_SAMPLINGMODE);

    //define default material for tiles
    var tileMaterial = new BABYLON.StandardMaterial("noLight", scene);
    tileMaterial.disableLighting = true;
    tileMaterial.emissiveColor = BABYLON.Color3.White();
    tileMaterial.diffuseTexture = atlas;
    tileMaterial.diffuseTexture.hasAlpha = true;

    //tiles
    for(let i=0; i<3; i++)
        originalBlockList.push(CreateTile(scene, i));

    originalEntityFall = CreateTile(scene, 2);
    originalEntityRock = CreateTile(scene, 3);
    originalEntityDoor = CreateTile(scene, 4);

    originalBoxCollider = BABYLON.MeshBuilder.CreateBox("b", {size:0}, scene);
    originalBoxCollider.isVisible = false;

    function CreateTile(scene, textureIndex)
    {
        var faceUV = new BABYLON.Vector4(textureIndex/8, 0, (textureIndex+1)/8, 1/6);

        var tile = BABYLON.MeshBuilder.CreatePlane("tile", {frontUVs:faceUV, width:1, height:1, sideOrientation:BABYLON.Mesh.DOUBLESIDE}, scene);
        tile.material = tileMaterial;
        tile.position = new BABYLON.Vector3(0, -100, 0);

        return tile;
    }
}

var walls = Array();
var doors = Array();
var backgroundTiles = Array();
var entities = Array();

var currentdjRoom = 0;
var dj = Array();

function loadlevel(level)
{
    var level_tab = level["layer0"].split(' ');

    var level_h = level.height;
    var level_w = level.width;

    var x_offset = level.width/2;
    var y_offset = level.height/2;

    walls.forEach(e => e.dispose());
    doors.forEach(e => e.dispose());
    backgroundTiles.forEach(e => e.dispose());
    entities.forEach(e => e.dispose());
    
    walls = Array();
    doors = Array();
    backgroundTiles = Array();
    entities = Array();

    // first layer
    for(let h = 0; h < level_h; h++)
    {
        for(let w = 0; w < level_w; w++)
        {
            var tile = level_tab[w + h*level_w];
            var pos = new BABYLON.Vector3(w - x_offset, (level_h - h) - y_offset, 0);
            if(tile == "1")
                backgroundTiles.push(instantiateTile(originalBlockList[0], pos));
            if(tile == "2")
                backgroundTiles.push(instantiateTile(originalBlockList[1], pos));
        }
    }

    var level_entities = level["layer1"].split(' ');

    // entity layer
    for(let h = 0; h < level_h; h++)
    {
        for(let w = 0; w < level_w; w++)
        {
            var tile = level_entities[w + h*level_w];
            var pos = new BABYLON.Vector3(w - x_offset, (level_h - h) - y_offset, 0);

            if(tile == "1") //boxwall
                walls.push(instantiateBlock(pos));

            if(tile == "2")
            {
                entities.push(instantiateTile(originalEntityFall, pos));
                entities.push(instantiateBlock(pos));
            }
            if(tile == "3")
            {
                entities.push(instantiateTile(originalEntityRock, pos));
                entities.push(instantiateBlock(pos));
            }
                
            if(tile == "4")
            {
                var door = instantiateTile(originalEntityDoor, pos)
                //entities.push(door);
                doors.push(["n",door]);
            }
            if(tile == "5")
            {
                var door = instantiateTile(originalEntityDoor, pos)
                //entities.push(door);
                doors.push(["e",door]);
            }
            if(tile == "6")
            {
                var door = instantiateTile(originalEntityDoor, pos)
                //entities.push(door);
                doors.push(["s",door]);
            }
            if(tile == "7")
            {
                var door = instantiateTile(originalEntityDoor, pos)
                //entities.push(door);
                doors.push(["o",door]);
            }
                
            
        }
    }

    console.log("level loaded!");
    //reload le level fait bug les projectiles
}

function loadnewlevel(level)
{
    var level_tab = level["layer0"].split(' ');

    var level_h = level.height;
    var level_w = level.width;

    var x_offset = level.width/2;
    var y_offset = level.height/2;

    walls.forEach(e => e.dispose());
    doors.forEach(e => e.dispose());
    backgroundTiles.forEach(e => e.dispose());
    entities.forEach(e => e.dispose());
    
    var levelwalls = Array();
    var leveldoors = Array();
    var levelbackgroundTiles = Array();
    var levelentities = Array();

    

    // first layer
    for(let h = 0; h < level_h; h++)
    {
        for(let w = 0; w < level_w; w++)
        {
            var tile = level_tab[w + h*level_w];
            var pos = new BABYLON.Vector3(w - x_offset, (level_h - h) - y_offset, 0);
            if(tile == "1")
                levelbackgroundTiles.push(instantiateTile(originalBlockList[0], pos));
            if(tile == "2")
                levelbackgroundTiles.push(instantiateTile(originalBlockList[1], pos));
        }
    }

    var level_entities = level["layer1"].split(' ');

    // entity layer
    for(let h = 0; h < level_h; h++)
    {
        for(let w = 0; w < level_w; w++)
        {
            var tile = level_entities[w + h*level_w];
            var pos = new BABYLON.Vector3(w - x_offset, (level_h - h) - y_offset, 0);

            if(tile == "1") //boxwall
                levelwalls.push(instantiateBlock(pos));

            if(tile == "2")
            {
                levelentities.push(instantiateTile(originalEntityFall, pos));
                levelentities.push(instantiateBlock(pos));
            }
            if(tile == "3")
            {
                levelentities.push(instantiateTile(originalEntityRock, pos));
                levelentities.push(instantiateBlock(pos));
            }
                
            if(tile == "4")
            {
                var door = instantiateTile(originalEntityDoor, pos)
                //entities.push(door);
                leveldoors.push(["n",door, 0]);
            }
            if(tile == "5")
            {
                var door = instantiateTile(originalEntityDoor, pos)
                //entities.push(door);
                leveldoors.push(["e",door, 0]);
            }
            if(tile == "6")
            {
                var door = instantiateTile(originalEntityDoor, pos)
                //entities.push(door);
                leveldoors.push(["s",door, 0]);
            }
            if(tile == "7")
            {
                var door = instantiateTile(originalEntityDoor, pos)
                //entities.push(door);
                leveldoors.push(["o",door, 0]);
            }
                
            
        }
    }

    console.log("level loaded!");
    //reload le level fait bug les projectiles
    var level = {"walls": levelwalls, "doors": leveldoors, "tiles": levelbackgroundTiles, "entities": levelentities };
    return level;

}

// --- instances function ---

function instantiateTile(tile, position)
{
    var instance = tile.createInstance("tileInstance");
    instance.position = position;

    return instance;
}

function instantiateBlock(position)
{
    var instance = instantiateTile(originalBoxCollider, position);
    instance.checkCollisions = true;
    instance.isVisible = false;

    return instance;
}

function generateDungeon()
{
    var dungeonRoomsMin = 4;

    var dungeonLayout = Array();

    var levelData = loadnewlevel(l);
    levelData['doors'][0][2] = 1;
    dungeonLayout.push(levelData);
    //enableRoom(levelData, false);

    for(let i=0;i<dungeonRoomsMin;i++)
    {
        var dungeonLevel = llevel[Math.floor(Math.random()*(llevel.length))];
        var levelData = loadnewlevel(dungeonLevel);
        levelData['doors'][0][2] = -1;
        levelData['doors'][1][2] = 1;
        dungeonLayout.push(levelData);
        

        enableRoom(levelData, false);
    }

    console.log("dungeon generated");
    return dungeonLayout;
}

function enableRoom(levelData, enabled)
{
    levelData['walls'].forEach(element => element.setEnabled(enabled));
    levelData['tiles'].forEach(element => element.setEnabled(enabled));
    levelData['doors'].forEach(element => element[1].setEnabled(enabled));
    levelData['entities'].forEach(element => element.setEnabled(enabled));
}